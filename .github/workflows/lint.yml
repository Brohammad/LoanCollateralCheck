name: Lint

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  lint:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"
    
    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-lint-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-lint-
    
    - name: Install linting dependencies
      run: |
        python -m pip install --upgrade pip
        pip install black flake8 mypy pylint isort
        pip install -r requirements.txt
    
    - name: Run Black (code formatter check)
      run: |
        black --check --diff app/ database/ monitoring/ config/ tests/
      continue-on-error: true
    
    - name: Run isort (import sorter check)
      run: |
        isort --check-only --diff app/ database/ monitoring/ config/ tests/
      continue-on-error: true
    
    - name: Run Flake8 (style guide enforcement)
      run: |
        flake8 app/ database/ monitoring/ config/ tests/ \
          --max-line-length=120 \
          --extend-ignore=E203,E266,E501,W503 \
          --max-complexity=15 \
          --statistics \
          --count
      continue-on-error: true
    
    - name: Run Pylint (code analysis)
      run: |
        pylint app/ database/ monitoring/ config/ \
          --max-line-length=120 \
          --disable=C0111,C0103,R0903,R0913,W0212 \
          --output-format=colorized \
          --score=yes
      continue-on-error: true
    
    - name: Run MyPy (static type checking)
      run: |
        mypy app/ database/ monitoring/ config/ \
          --ignore-missing-imports \
          --disallow-untyped-defs \
          --no-implicit-optional \
          --warn-redundant-casts \
          --warn-unused-ignores \
          --show-error-codes
      continue-on-error: true
    
    - name: Check docstring coverage
      run: |
        pip install interrogate
        interrogate -v app/ database/ monitoring/ config/ \
          --fail-under=70 \
          --ignore-init-method \
          --ignore-init-module
      continue-on-error: true
    
    - name: Lint Summary
      if: always()
      run: |
        echo "## Linting Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "All linting checks completed. Review individual steps for details." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Checks Run:" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ Black (code formatting)" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ isort (import sorting)" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ Flake8 (style guide)" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ Pylint (code analysis)" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ MyPy (type checking)" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ Docstring coverage" >> $GITHUB_STEP_SUMMARY
