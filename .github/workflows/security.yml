name: Security

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run security scans daily at 00:00 UTC
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  dependency-scan:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install safety bandit semgrep
        pip install -r requirements.txt
    
    - name: Run Safety (dependency vulnerability scanner)
      run: |
        safety check --json --output safety-report.json || true
        safety check || true
      continue-on-error: true
    
    - name: Upload Safety report
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: safety-report
        path: safety-report.json
        retention-days: 30
    
    - name: Run Bandit (security linter)
      run: |
        bandit -r app/ database/ monitoring/ config/ \
          -f json -o bandit-report.json \
          --skip B101,B601 \
          --severity-level medium || true
        bandit -r app/ database/ monitoring/ config/ \
          --skip B101,B601 \
          --severity-level medium || true
      continue-on-error: true
    
    - name: Upload Bandit report
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: bandit-report
        path: bandit-report.json
        retention-days: 30
    
    - name: Run Semgrep (static analysis)
      run: |
        semgrep --config=auto app/ database/ monitoring/ config/ \
          --json --output=semgrep-report.json || true
        semgrep --config=auto app/ database/ monitoring/ config/ || true
      continue-on-error: true
    
    - name: Upload Semgrep report
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: semgrep-report
        path: semgrep-report.json
        retention-days: 30

  secret-scan:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history for secret scanning
    
    - name: Run Gitleaks (secret scanner)
      uses: gitleaks/gitleaks-action@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      continue-on-error: true
    
    - name: Run TruffleHog (secret scanner)
      run: |
        docker run --rm -v "$PWD:/pwd" trufflesecurity/trufflehog:latest \
          github --repo file:///pwd || true
      continue-on-error: true

  code-quality:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install radon mccabe
    
    - name: Run Radon (code complexity analyzer)
      run: |
        radon cc app/ database/ monitoring/ config/ -a -s || true
        radon mi app/ database/ monitoring/ config/ -s || true
      continue-on-error: true
    
    - name: Check cyclomatic complexity
      run: |
        radon cc app/ database/ monitoring/ config/ -n D -s || true
      continue-on-error: true

  dependency-review:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - name: Dependency Review
      uses: actions/dependency-review-action@v3
      with:
        fail-on-severity: moderate

  security-summary:
    runs-on: ubuntu-latest
    needs: [dependency-scan, secret-scan, code-quality]
    if: always()
    
    steps:
    - name: Security Summary
      run: |
        echo "## Security Scan Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Security scans completed:" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- Dependency Scan: ${{ needs.dependency-scan.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Secret Scan: ${{ needs.secret-scan.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Code Quality: ${{ needs.code-quality.result }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“Š Review detailed reports in the artifacts section." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Scans Performed:" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Safety (dependency vulnerabilities)" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Bandit (security linting)" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Semgrep (static analysis)" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Gitleaks (secret scanning)" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… TruffleHog (secret scanning)" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Radon (code complexity)" >> $GITHUB_STEP_SUMMARY
